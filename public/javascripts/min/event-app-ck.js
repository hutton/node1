window.EventApp=Backbone.View.extend({initialize:function(){_.bindAll(this)},loadBootstrapData:function(e,t,i){this.model=new CalendarModel(i),this.choices=new ChoicesModel,this.choices.reset(expandDates(e,this.model.get("everythingSelectable"))),this.attendees=new Backbone.Collection,this.attendees.comparator=function(e){return!e.get("me")},this.attendees.reset(t),this.currentAttendee=this.attendees.findWhere({me:!0}),this.currentAttendeeId=null!=this.currentAttendee?this.currentAttendee.get("_id"):-1,_.isUndefined(this.currentAttendee)&&(this.currentAttendee=null,this.newMode=!0,this.attendees.add({prettyName:"Me",_id:"new",me:!0},{at:0})),this.ChoicesView=new ChoicesView({collection:this.choices,attendees:this.attendees}),this.ChoicesView.render(),this.TopChoicesModel=new Backbone.Model({one:null,two:null,three:null}),this.LoaderView=new LoaderView,this.LoaderView.calendarModel=this.model,this.LoaderView.attendees=this.attendees,this.LoaderView.choices=this.choices,this.LoaderView.topChoicesModel=this.TopChoicesModel,this.AttendeesView=new AttendeesView({collection:this.choices,model:this.TopChoicesModel}),this.SettingsView=new SettingsView,this.SelectDatesView=new SelectDatesView({collection:this.choices});var n=window.location.pathname.split("/");this.currentId=n[n.length-1],this.render(),this.checkForOrientationChange(),this.scrollToFirstSelectable(),this.LoaderView.show()},el:$("body"),today:new Date((new Date).toDateString()),events:{"click #show-info":"infoClicked","keyup #register-attendee-email-input":"registerAttendeeInputChanged","click .join-event":"showJoinEvent","click .title":"showLoader",click:"onClick"},selectedRowTemplate:_.template($("#selected-row-template").html()),isFree:[],wasFree:[],showInfo:!1,infoClicked:function(){this.SettingsView.show(),this.showInfo=!this.showInfo},topNavBarEl:$(".navbar-fixed-top"),scrollStarted:!1,newMode:!1,selectableDateMode:!1,render:function(){var e=this;this.newMode?(_.delay(function(){e.$el.find(".join-event").removeClass("join-event-hidden")},1e3),this.titleMailEl.click(function(){e.showNewModeMail()})):(this.updateTellEveryoneLink(),this.recalcTopSpacer(),this.$el.find("#show-info").show(),this.$el.find("#title-button-help").hide()),this.$el.find("#register-form").attr("action","/event/"+this.currentId+"/add/"),this.SettingsView.initialize(),this.showBestChoices(),this.model.get("datesSelected")||this.changeSelectableDates(),this.instantResize(),this.onResizeWindow(),_.delay(function(){e.titleResize()},100);var t=_.debounce(e.onResizeWindow,100);$(window).resize(function(){t(),e.instantResize()})},realignAdorners:function(){this.TopChoicesModel.has("one")&&this.TopChoicesModel.get("one").trigger("repositioned"),this.TopChoicesModel.has("two")&&this.TopChoicesModel.get("two").trigger("repositioned"),this.TopChoicesModel.has("three")&&this.TopChoicesModel.get("three").trigger("repositioned")},onResizeWindow:function(){this.ChoicesView.resize(),this.AttendeesView.resize();var e=$(window).width(),t=$(window).height();350>t?(this.showHeader(!1),this.AttendeesView.show()):this.showHeader(!0),this.titleResize()},instantResize:function(){this.titleResize()},titleResize:function(){var e=21,t=12,i=e,n=$(".title");for(n.css({"font-size":i}),n.css({"line-height":"30px"});n.height()>42&&i>t;)n.css({"font-size":i}),i-=2;n.height()>42&&t>=i&&n.css({"line-height":"16px"})},checkOrientation:function(){window.orientation!==this.previousOrientation&&(this.previousOrientation=window.orientation,0===window.orientation||180===window.orientation)},checkForOrientationChange:function(){this.previousOrientation=window.orientation,window.addEventListener("resize",this.checkOrientation,!1),window.addEventListener("orientationchange",this.checkOrientation,!1)},registerAttendeeInputChanged:function(e){if(13!=e.which){var t=$(".register-attendee-message");t.html(""),messages.slideUp("fast")}},isEmailAddressValid:function(e){var t=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,i=e.match(t);return!_.isUndefined(i)&&null!==i},changesMadeLinkkeyEl:$(".changes-made-email-link"),updatedFooterEl:$("#updated-footer"),titleMailEl:$("#title-mail"),switchedUpdateAttendeesLink:!1,updateTellEveryoneLink:function(){var e="mailto:"+this.model.get("id")+"@convenely.com?subject=RE:"+encodeURIComponent(" "+this.model.get("name"))+"&body="+encodeURIComponent(this.formatUpdatedDays(this.isFree,this.wasFree));this.changesMadeLinkkeyEl.attr("href",e)},formatUpdatedDays:function(e,t){return e.length>0?t.length>0?"I'm now free on "+this.buildDatesString(e)+" but I'm no longer free on "+this.buildDatesString(t)+".":"I'm now free on "+this.buildDatesString(e)+".":t.length>0?"I'm no longer free on "+this.buildDatesString(t)+".":""},buildDatesString:function(e){var t="";e=e.sort(function(e,t){return e>t});var i=_.map(e,function(e){return moment(e).format("dddd Do MMMM")});return i.length>0&&(1==i.length?t+=i[0]:t=t+i.slice(0,-1).join(", ")+" and "+i[i.length-1]),t},validateEmail:function(){var e=$("#register-attendee-email-input"),t=$(".register-attendee-message");return null===e.val()||""===e.val()?(t.html("Please enter your email address"),t.slideDown("fast"),!1):this.isEmailAddressValid(e.val())?void 0:(t.html("Please enter a valid email address"),t.slideDown("fast"),!1)},showBestChoices:function(){var e=this,t=null,i=0,n=null,s=0,o=null,a=0,h=[];_.each(this.choices.models,function(l){var d=0;l.isSelectable()&&l.has("date")&&l.get("date")>=e.today&&(l.has("free")&&(d+=l.get("free").length),d+=l.pretendFree?1:0,d>i?(a=s,o=n,s=i,n=t,i=d,t=l):d>s?(a=s,o=n,s=d,n=l):d>a&&(a=d,o=l),l.has("top-choice")&&h.push(l))}),null!==t?(t.setTopChoice(1),$(".calendar-choices-top-one").show()):$(".calendar-choices-top-one").hide(),null!==n?(n.setTopChoice(2),$(".calendar-choices-top-two").show()):$(".calendar-choices-top-two").hide(),null!==o?(o.setTopChoice(3),$(".calendar-choices-top-three").show()):$(".calendar-choices-top-three").hide(),_.each(h,function(e){e!==t&&e!==n&&e!==o&&e.unset("top-choice")}),this.TopChoicesModel.set({one:t,two:n,three:o})},recalcTopSpacer:function(){if(this.$el.find(".navbar-fixed-top").is(":visible")){var e=this.$el.find(".navbar-fixed-top").height();this.$el.find(".event-container").css({"padding-top":e}),this.$el.find(".selecting-dates-container").css("top",e),this.$el.find(".selecting-dates-saving-container").css("top",e)}else this.$el.find(".event-container").css({"padding-top":0}),this.$el.find(".selecting-dates-container").css("top",0),this.$el.find(".selecting-dates-saving-container").css("top",0)},showHeader:function(e){e?this.$el.find(".navbar-fixed-top").show():this.$el.find(".navbar-fixed-top").hide(),this.recalcTopSpacer()},changeSelectableDates:function(){this.SelectDatesView.show()},selectedModel:null,setSelected:function(e){this.selectedModel!==e&&(null!==this.selectedModel&&this.selectedModel.set("selected",!1),this.selectedModel=e,null!==e&&(e.set("selected",!0),this.AttendeesView.setActive(e)))},scrollToFirstSelectable:function(){var e=this.choices.findWhere({selectable:!0});null===e||_.isUndefined(e)||e.trigger("scrollToTopLine")},scrollToSelected:function(){var e=this.choices.findWhere({selected:!0});null===e||_.isUndefined(e)||e.trigger("scrollToTopLine")},showJoinEvent:function(){var e=$("#join-view"),t=e.find(".join-view-text");t.html(0===this.isFree.length?"You've not selected any dates but that's fine.":1===this.isFree.length?"You have selected one date.":"You have selected "+this.isFree.length+" dates."),e.modal({show:!0})},showNewModeMail:function(){var e=$("#new-mode-mail-view");e.modal({show:!0})},showLoader:function(){this.LoaderView.show()},onClick:function(e){var t=$(e.target);0!==t.parents(".attendees-container").length||0!==t.parents(".date-cell").length&&!t.parents(".date-cell").hasClass("unselectable")||this.AttendeesView.onClose()}});